# Using the SAP Cloud SDK OData Client

This document explains how to use the OData V4 client generated by the SAP Cloud SDK (`@sap-cloud-sdk/generator`) located in `src/generated/d365-client/` to interact with the Dynamics 365 API from within MCP Hub tool implementations (located in `src/mcp_hub/src/tools/`).

## Overview

The SAP Cloud SDK provides a type-safe way to build and execute OData requests. The core pattern involves:
1.  Importing the specific API object for the desired entity (e.g., `customersV3Api`).
2.  Retrieving the Dynamics 365 base URL and an authentication token.
3.  Constructing an `HttpDestination` object containing the URL and the authentication token as a header.
4.  Using the imported API object's `requestBuilder()` method to build the query (e.g., `getAll()`, `getByKey()`).
5.  Applying filters, selects, ordering, etc., using the builder's fluent API and the generated schema constants.
6.  Executing the request using the `.execute(destination)` method, passing the `HttpDestination` object.

## Prerequisites

Ensure the following package is installed in the `src/mcp_hub/` project:
```bash
npm install @sap-cloud-sdk/connectivity
```

## Example: Implementing `get_customer_by_name` Tool

```typescript
// src/mcp_hub/src/tools/finance/getCustomerByName.ts

import { z } from "zod";
import { getD365AuthToken, getD365Url } from "../../core/auth"; // Adjust path as needed

// SAP Cloud SDK specific imports
import { HttpDestination } from "@sap-cloud-sdk/connectivity";
// Import the generated API from the root index file of the generated client
import { customersV3Api } from "../../../../generated/d365-client"; // Adjust path as needed

// Define input schema shape using Zod
export const getCustomerByNameInputShape = z.object({
  customerName: z.string().describe("The exact Organization Name of the customer to search for."),
  company: z.string().optional().describe("The company code (e.g., USMF, FR01). If omitted, searches across companies."),
});

// Infer input type
type GetCustomerByNameInput = z.infer<typeof getCustomerByNameInputShape>;

// Define metadata for the tool
export const getCustomerByNameMetadata = {
    name: "get_customer_by_name",
    description: "Retrieves customer details from Dynamics 365 Finance using SAP Cloud SDK Client.",
    input: getCustomerByNameInputShape.shape,
};

// Define handler function
export async function getCustomerByNameHandler(args: GetCustomerByNameInput) {
    const { customerName, company } = args;
    console.log(`Tool '${getCustomerByNameMetadata.name}' called with args:`, { customerName, company });

    try {
        // 1. Get URL and Auth Token
        const d365BaseUrl = await getD365Url();
        const authToken = await getD365AuthToken();

        // 2. Construct HttpDestination object
        const destination: HttpDestination = {
            url: d365BaseUrl + '/data', // Append the OData service path
            authentication: 'NoAuthentication', // We provide token via header
            headers: {
                Authorization: `Bearer ${authToken}`,
                Accept: 'application/json',
                'OData-MaxVersion': '4.0',
                'OData-Version': '4.0',
            }
        };

        // 3. Build the request
        const schema = customersV3Api.schema; // Access the schema definition
        const requestBuilder = customersV3Api
            .requestBuilder()
            .getAll()
            .filter(schema.NAME.equals(customerName)); // Use schema constants for fields

        if (company) {
            requestBuilder.filter(schema.DATA_AREA_ID.equals(company));
        }

        requestBuilder.select(
            schema.CUSTOMER_ACCOUNT,
            schema.NAME,
            schema.CREDIT_LIMIT,
            schema.PARTY_TYPE,
            schema.DATA_AREA_ID
        );
        requestBuilder.top(1);

        if (!company) {
            requestBuilder.withCustomQueryParameters({ 'cross-company': 'true' });
        }

        // 4. Execute the request
        const result = await requestBuilder.execute(destination);

        // 5. Process the result
        if (result && result.length > 0) {
            const customerData = result[0];
            // Directly use the typed result object
            const plainCustomerData = {
                CustomerAccount: customerData.customerAccount,
                Name: customerData.name,
                CreditLimit: customerData.creditLimit,
                PartyType: customerData.partyType,
                dataAreaId: customerData.dataAreaId,
            };
             return { content: [{ type: "text", text: JSON.stringify(plainCustomerData, null, 2) }] };
        } else {
             const errorResult = { error: "Customer not found", customerName, company };
             return { content: [{ type: "text", text: JSON.stringify(errorResult, null, 2) }], isError: true };
        }

    } catch (error: any) {
        // Handle errors (simplified example)
        console.error(`Error executing ${getCustomerByNameMetadata.name}: ${error.message}`, error.stack);
        const errorResult = { error: `Failed to retrieve customer: ${error.message}` };
        return { content: [{ type: "text", text: JSON.stringify(errorResult, null, 2) }], isError: true };
    }
}
```

## Key Points

*   **Destination Object:** The `HttpDestination` object is crucial. It encapsulates the target URL and necessary headers (like `Authorization`). Set `authentication: 'NoAuthentication'` when providing the token manually via headers.
*   **Service Path:** Ensure the service path (e.g., `/data` for D365 FO) is appended to the base URL in the `destination.url`.
*   **Generated API:** Import the specific API object (e.g., `customersV3Api`) from the generated client's entry point (likely `src/generated/d365-client/index.ts`).
*   **Schema:** Use the `schema` property of the API object (e.g., `customersV3Api.schema`) to access strongly-typed field names (e.g., `schema.NAME`, `schema.CUSTOMER_ACCOUNT`) for building filters and selects.
*   **Fluent API:** Chain methods like `getAll()`, `filter()`, `select()`, `top()`, `withCustomQueryParameters()` on the `requestBuilder()` to configure the request.
*   **Execution:** Use `.execute(destination)` to send the request. The result is typically a typed array of entities for `getAll` requests.
