# D365 OData Client Usage

This document provides guidance on generating and utilizing type-safe OData clients for Dynamics 365 within the MCP Server implementations. The specific approach depends on the chosen language for the MCP Server.

## Option A: TypeScript MCP Server (`d365-agent-mcpserver-ts`)

For the TypeScript server, we use an OData client generated by the SAP Cloud SDK OData Generator (or compatible tools like `odata2ts`).

### Generation Process

*   **Repository:** [`d365-agent-odataclient-ts`](https://github.com/ntrtd/d365-agent-odataclient-ts)
*   **Tool:** SAP Cloud SDK OData Generator (`@sap-cloud-sdk/generator`) or `odata2ts` (see `submodules/odata2ts`).
*   **Input:** `asset/d365_metadata.xml` (from [`d365-agent`](https://github.com/ntrtd/d365-agent) repo).
*   **Output:** A TypeScript client library, published as an **npm package** (e.g., `@d365-agent/odataclient`).
*   **Process:** The `d365-agent-odataclient-ts` repository contains the scripts and CI/CD pipeline to execute the generator using the input metadata and publish the resulting package.

### Consumption in `d365-agent-mcpserver-ts`

1.  **Add Dependency:** Install the published npm package (`@d365-agent/odataclient`) in the [`d365-agent-mcpserver-ts`](https://github.com/ntrtd/d365-agent-mcpserver-ts) project.
    ```bash
    npm install @d365-agent/odataclient @sap-cloud-sdk/connectivity
    ```
2.  **Import Entities/APIs:** Import required entities and API functions within MCP Tool implementations (e.g., `src/tools/`).
    ```typescript
    import { CustomerV3 } from '@d365-agent/odataclient'; // Example entity
    import { customersV3Api } from '@d365-agent/odataclient'; // Example API
    ```
3.  **Authentication & Destination:** Use SAP Cloud SDK's connectivity features (`@sap-cloud-sdk/connectivity`) to handle authentication (e.g., Client Credentials flow via Key Vault) and create an `HttpDestination`.
    ```typescript
    // Example (Simplified - within an MCP tool or shared service)
    import { HttpDestination } from "@sap-cloud-sdk/connectivity";
    // ... auth logic to get URL, clientId, clientSecret, tenantId ...

    async function getDestination(company: string): Promise<HttpDestination> {
        const d365Url = /* ... fetch URL for company ... */;
        const clientId = /* ... fetch client ID ... */;
        const clientSecret = /* ... fetch client secret ... */;
        const tenantId = /* ... fetch tenant ID ... */;

        const destination: HttpDestination = {
            url: d365Url, // Base URL of D365 environment + '/data' path
            authentication: 'OAuth2ClientCredentials',
            clientId: clientId,
            clientSecret: clientSecret,
            tokenServiceUrl: `https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/token`,
        };
        return destination;
    }
    ```
4.  **Execute Requests:** Use the imported API functions with the destination.
    ```typescript
    // Example within an MCP Tool implementation
    import { customersV3Api, CustomerV3 } from '@d365-agent/odataclient';
    import { z } from "zod";
    // ... other imports including getDestination ...

    // Assuming 'server' is the McpServer instance
    server.tool(
      'getCustomerByNameTS',
      { customerName: z.string(), company: z.string() },
      async ({ customerName, company }) => {
        try {
          const destination = await getDestination(company);
          const customers = await customersV3Api
            .requestBuilder()
            .getAll()
            .filter(customersV3Api.schema.NAME.equals(customerName)) // Use schema constants
            .select(customersV3Api.schema.CUSTOMER_ACCOUNT, customersV3Api.schema.NAME)
            .top(1)
            .execute(destination);
          // ... process results ...
          return { content: [{ type: "text", text: JSON.stringify(customers[0] ?? null) }] };
        } catch (error: any) {
          // ... error handling ...
          return { content: [{ type: "text", text: `Error: ${error.message}` }], isError: true };
        }
      }
    );
    ```

## Option B: C#/.NET MCP Server (`d365-agent-mcpserver-dotnet`)

For the C# server, we use an OData client generated by tools like OData Connected Service or `Microsoft.OData.Client.Design`.

### Generation Process

*   **Repository:** [`d365-agent-odataclient-dotnet`](https://github.com/ntrtd/d365-agent-odataclient-dotnet)
*   **Tool:** OData Connected Service (Visual Studio Extension - see `submodules/ODataConnectedService`) or `Microsoft.OData.Client.Design` (CLI tool).
*   **Input:** `asset/d365_metadata.xml` (from [`d365-agent`](https://github.com/ntrtd/d365-agent) repo) or the D365 OData service endpoint URL.
*   **Output:** C# classes representing entities and a `DataServiceContext` derived class. Published as a **NuGet package**.
*   **Process:** The `d365-agent-odataclient-dotnet` repository contains the project structure and CI/CD pipeline to execute the generator and publish the resulting package.

### Consumption in `d365-agent-mcpserver-dotnet`

1.  **Add Dependency:** Add the published NuGet package (containing the generated client) as a dependency to the [`d365-agent-mcpserver-dotnet`](https://github.com/ntrtd/d365-agent-mcpserver-dotnet) project.
    ```powershell
    dotnet add package Your.Generated.ODataClient.PackageName
    ```
2.  **Instantiate Context:** Create an instance of your generated `DataServiceContext` derived class.
3.  **Authentication:** Handle authentication (e.g., Client Credentials flow) by acquiring an OAuth token and attaching it to requests. This is typically done by handling the `SendingRequest2` event of the `DataServiceContext`.
    ```csharp
    // Example Authentication Handling (Simplified)
    // Assume GetOAuthTokenAsync() fetches a valid token
    // Assume 'context' is your generated DataServiceContext instance

    context.SendingRequest2 += async (sender, eventArgs) => {
        var token = await GetOAuthTokenAsync(/* necessary params like company */);
        eventArgs.RequestMessage.SetHeader("Authorization", $"Bearer {token}");
    };
    ```
4.  **Execute Requests:** Use LINQ queries against the `DataServiceContext` properties representing entity sets.
    ```csharp
    // Example within an MCP Tool implementation
    using Your.Generated.ODataClient.Namespace; // Import generated namespace
    using Microsoft.OData.Client;
    using System.ComponentModel;
    // ... other necessary usings (MCP Server attributes etc) ...

    [McpServerToolType]
    public static class CustomerToolsDotNet
    {
        [McpServerTool, Description("Gets customer by name using .NET OData Client")]
        public static async Task<string> GetCustomerByNameDotNet(
            [Description("Customer Name")] string customerName,
            [Description("Company Code")] string company)
        {
            try
            {
                // 1. Get D365 Base URL for the company
                Uri serviceRoot = new Uri($"https://your-d365-instance-{company}.operations.dynamics.com/data"); // Example URL structure
                var context = new YourGeneratedDataServiceContext(serviceRoot); // Replace with your context class

                // 2. Setup Authentication (Attach token on sending request)
                context.SendingRequest2 += async (sender, eventArgs) => {
                    var token = await GetOAuthTokenAsync(company); // Implement this
                    eventArgs.RequestMessage.SetHeader("Authorization", $"Bearer {token}");
                };

                // 3. Build LINQ Query
                DataServiceQuery<CustomerV3> query = context.CustomersV3 // Assuming 'CustomersV3' is the entity set name
                    .AddQueryOption("$filter", $"Name eq '{Uri.EscapeDataString(customerName)}'")
                    .AddQueryOption("$top", "1") as DataServiceQuery<CustomerV3>;

                 // Add cross-company if needed and no specific company filter applied via URL/context
                 // query = query.AddQueryOption("cross-company", "true");

                // 4. Execute Query
                var customers = await Task.Factory.FromAsync(query.BeginExecute(null, null), (ar) => query.EndExecute(ar));
                var customer = customers.FirstOrDefault();

                // 5. Process Result
                if (customer != null)
                {
                    return System.Text.Json.JsonSerializer.Serialize(new { customer.CustomerAccount, customer.Name });
                }
                else
                {
                    throw new McpException($"Customer '{customerName}' not found.");
                }
            }
            catch (Exception ex)
            {
                // Log error
                throw new McpException($"Error fetching customer: {ex.Message}", ex);
            }
        }

        private static async Task<string> GetOAuthTokenAsync(string company)
        {
            // Implement logic to fetch OAuth token using Client Credentials flow
            // Retrieve clientId, clientSecret, tenantId, scope from KeyVault based on company
            // Use MSAL or HttpClient to get the token
            await Task.Delay(10); // Placeholder
            return "DUMMY_TOKEN";
        }
    }
    ```

## Key Differences

*   **Generation Tool:** SAP Cloud SDK / `odata2ts` (TS) vs. OData Connected Service / `Microsoft.OData.Client.Design` (.NET).
*   **Client Library:** SAP Cloud SDK client library (TS) vs. `Microsoft.OData.Client` library (.NET).
*   **Query Building:** Fluent API with schema constants (TS) vs. LINQ queries against `DataServiceContext` (.NET).
*   **Authentication Hook:** Handled via `HttpDestination` configuration (TS) vs. `SendingRequest2` event handler (.NET).

Choose the approach that aligns with the implementation language of your MCP Server in the [`d365-agent-mcpserver-ts`](https://github.com/ntrtd/d365-agent-mcpserver-ts) or [`d365-agent-mcpserver-dotnet`](https://github.com/ntrtd/d365-agent-mcpserver-dotnet) repository.
